# Fix: Proxy Empty Response - Glider Timeout & Dial Issues

## 问题描述

用户在使用代理时遇到空响应问题：
- 通过 curl 使用代理请求时返回空响应
- glider 日志显示 `i/o timeout` 和 `dial tcp :0->IP:PORT: i/o timeout` 错误
- 后端代理节点无法在默认超时时间内建立连接

## 根本原因

1. **默认超时时间太短**：glider 默认 dial timeout 为 3 秒，对于网络状况不佳或距离较远的节点可能不足
2. **缺少中继超时配置**：没有配置 relay timeout，导致长时间连接可能意外断开
3. **健康检查超时不可配置**：check timeout 固定，无法根据实际情况调整
4. **失败容忍度不可配置**：max failures 参数固定，无法快速标记失效节点

## 解决方案

### 1. 增加超时配置参数

在 `proxychain/config.py` 中新增以下可配置参数：

- `GLIDER_DIAL_TIMEOUT`：连接后端代理的超时时间（秒），默认 `10`
- `GLIDER_RELAY_TIMEOUT`：转发超时时间（秒），默认 `30`，设为 `0` 禁用
- `GLIDER_CHECK_TIMEOUT`：健康检查超时时间（秒），默认 `8`
- `GLIDER_MAX_FAILURES`：节点失败多少次后标记为不可用，默认 `2`

### 2. 更新 glider 配置生成逻辑

修改 `proxychain/glider_manager.py` 中的 `_build_config` 方法：
- 添加 `dialtimeout` 配置（默认 10 秒，比原来的 3 秒增加 233%）
- 添加 `relaytimeout` 配置（可选，默认 30 秒）
- 添加 `checktimeout` 配置（默认 8 秒）
- 添加 `maxfailures` 配置（默认 2 次）
- 支持通过环境变量动态调整所有超时参数

### 3. 更新文档

- 在 `README.md` 中添加新的环境变量说明
- 在故障排查章节中添加超时问题的解决方案
- 在 `docker-compose.yml` 中添加超时配置的注释示例

## 生成的配置示例

### 默认配置
```conf
# Auto-generated by proxychain
verbose=true
listen=socks5://0.0.0.0:25000
strategy=rr
dialtimeout=10
maxfailures=2
relaytimeout=30
check=http://www.msftconnecttest.com/connecttest.txt#expect=200
checkinterval=60
checktimeout=8
forward=ss://aes-256-gcm:password@example.com:8388
```

### 自定义超时配置
```bash
# 设置更长的超时时间
export GLIDER_DIAL_TIMEOUT=15
export GLIDER_RELAY_TIMEOUT=60
export GLIDER_CHECK_TIMEOUT=10
```

## 使用方法

### Docker Compose 部署

在 `docker-compose.yml` 中添加或修改环境变量：

```yaml
environment:
  - GLIDER_DIAL_TIMEOUT=15  # 增加拨号超时到15秒
  - GLIDER_RELAY_TIMEOUT=60  # 增加转发超时到60秒
  - GLIDER_CHECK_TIMEOUT=10  # 增加健康检查超时到10秒
  - GLIDER_MAX_FAILURES=3    # 3次失败后标记为不可用
```

然后重启服务：
```bash
docker compose down && docker compose up -d
```

### 本地部署

设置环境变量后启动服务：
```bash
export GLIDER_DIAL_TIMEOUT=15
export GLIDER_RELAY_TIMEOUT=60
uvicorn proxychain.main:app --host 0.0.0.0 --port 8000
```

## 预期效果

1. **减少超时错误**：更长的 dial timeout 给予节点更多时间建立连接
2. **提高稳定性**：relay timeout 确保长时间连接不会意外断开
3. **更准确的健康检查**：可配置的 check timeout 适应不同的网络环境
4. **快速故障转移**：较小的 max failures 值让系统更快识别失效节点

## 注意事项

1. **超时设置权衡**：
   - 过短：可能导致正常但较慢的节点被误判为失效
   - 过长：可能导致失效节点长时间占用连接，影响用户体验

2. **推荐设置**：
   - 免费节点：`GLIDER_DIAL_TIMEOUT=15`, `GLIDER_RELAY_TIMEOUT=60`
   - 付费机场：默认值即可，或略微降低以提高响应速度
   - 自建节点：根据实际网络延迟调整

3. **节点质量**：
   - 免费节点经常失效，即使增加超时也可能无法解决所有问题
   - 建议使用付费机场或自建节点以获得更稳定的服务

## 相关文件变更

- `proxychain/config.py`：添加超时相关配置字段
- `proxychain/glider_manager.py`：更新配置生成逻辑
- `README.md`：添加环境变量说明和故障排查建议
- `docker-compose.yml`：添加超时配置注释示例
- `CHANGELOG_fix_timeout.md`：本文档

## 测试验证

```bash
# 验证配置正确加载
python3 -c "from proxychain.config import Settings; s = Settings(); \
print(f'dial_timeout={s.glider_dial_timeout}, relay_timeout={s.glider_relay_timeout}')"

# 验证环境变量覆盖
GLIDER_DIAL_TIMEOUT=20 python3 -c "from proxychain.config import Settings; s = Settings(); \
print(f'dial_timeout={s.glider_dial_timeout}')"

# 验证生成的配置文件
LOG_LEVEL=DEBUG uvicorn proxychain.main:app --host 0.0.0.0 --port 8000
# 查看日志中的配置文件内容
```
